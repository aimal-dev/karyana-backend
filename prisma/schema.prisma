generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//
// -------------------------
//      USER (BUYERS)
// -------------------------
//

model User {
  id         Int         @id @default(autoincrement())
  name       String?
  email      String      @unique
  password   String

  resetToken       String?    // For password reset
  resetTokenExpiry DateTime?  // Token expiration time

  orders     Order[]
  reviews    Review[]
  
  notifications Notification[]
  
  address    String?
  city       String?
  phone      String?
  role       String      @default("USER") // USER, ADMIN

  complaints       Complaint[]          @relation("UserComplaints")      // complaints created by user
  sellerComplaints Complaint[]          @relation("SellerComplaints")    // complaints received as seller

  //Cart relation
  cart     Cart?   // One-to-one relation (user can have 0 or 1 cart)

  createdAt  DateTime    @default(now())
}

//
// -------------------------
//     SINGLE SELLER ADMIN
// -------------------------
//

model Seller {
  id         Int       @id @default(autoincrement())
  name       String
  email      String    @unique
  password   String

  resetToken       String?    // For password reset
  resetTokenExpiry DateTime?  // Token expiration time

  products   Product[]
  categories Category[]
  notifications Notification[]
  
  phone            String?
  whatsappApiKey   String?
  approved         Boolean  @default(false)
  createdAt  DateTime  @default(now())
}

//
// -------------------------
//        CATEGORY
// -------------------------
//

model Category {
  id        Int      @id @default(autoincrement())
  name      String
  image     String?

  seller    Seller?  @relation(fields: [sellerId], references: [id])
  sellerId  Int?

  products  Product[]
}

//
// -------------------------
//         PRODUCT
// -------------------------
//

model Product {
  id          Int        @id @default(autoincrement())
  title       String
  description String?
  price       Float
  stock       Int        @default(0)
  image       String?

  seller      Seller     @relation(fields: [sellerId], references: [id])
  sellerId    Int        // ALWAYS 1

  category    Category   @relation(fields: [categoryId], references: [id])
  categoryId  Int

  reviews     Review[]
  orderItems  OrderItem[]

  cartItems   CartItem[]

  complaints  Complaint[] // optional complaints related to this product

  images      ProductImage[]
  
  isFeatured  Boolean    @default(false)
  isTrending  Boolean    @default(false)
  isOnSale    Boolean    @default(false)
  oldPrice    Float?
  tags        String[]   @default([])

  createdAt   DateTime   @default(now())
}

model ProductImage {
  id        Int      @id @default(autoincrement())
  url       String
  productId Int
  product   Product  @relation(fields: [productId], references: [id])
}

//
// -------------------------
//           ORDER
// -------------------------
//

model Order {
  id         Int         @id @default(autoincrement())

  user       User        @relation(fields: [userId], references: [id])
  userId     Int

  total      Float
  status     String      @default("PENDING")
  createdAt  DateTime    @default(now())

  shippingAddress String?
  shippingCity    String?
  shippingPhone   String?

  items      OrderItem[]

  trackingHistory TrackingHistory[]

  payment Payment?

  complaints Complaint[] // optional complaints related to this order
}

//
// -------------------------
//        ORDER ITEM
// -------------------------
//

model OrderItem {
  id         Int       @id @default(autoincrement())

  order      Order     @relation(fields: [orderId], references: [id])
  orderId    Int

  product    Product   @relation(fields: [productId], references: [id])
  productId  Int

  qty        Int
  price      Float
}
//
// -------------------------
//     TRACKING HISTORY
// -------------------------
//

model TrackingHistory {
  id        Int      @id @default(autoincrement())
  orderId   Int
  order     Order    @relation(fields: [orderId], references: [id])
  status    String
  message   String?
  createdAt DateTime @default(now())
}

//
// -------------------------
//         REVIEW
// -------------------------
//

model Review {
  id         Int       @id @default(autoincrement())

  user       User      @relation(fields: [userId], references: [id])
  userId     Int

  product    Product   @relation(fields: [productId], references: [id])
  productId  Int

  rating     Int
  comment    String?
  reply      String?   // seller reply
  createdAt  DateTime @default(now())
}


//
// -------------------------
//        COMPLAINT
// -------------------------
model Complaint {
  id         Int       @id @default(autoincrement())

  user       User      @relation("UserComplaints", fields: [userId], references: [id])
  userId     Int

  seller     User?     @relation("SellerComplaints", fields: [sellerId], references: [id])
  sellerId   Int?

  product    Product?  @relation(fields: [productId], references: [id])
  productId  Int?

  order      Order?    @relation(fields: [orderId], references: [id])
  orderId    Int?

  subject    String
  message    String
  status     String     @default("PENDING")

  sellerReply String?   
  userReply   String?   

  createdAt  DateTime   @default(now())
}

//
// -------------------------
//        CART
// -------------------------
//

model Cart {
  id      Int       @id @default(autoincrement())
  userId  Int       @unique
  user    User      @relation(fields: [userId], references: [id])
  items   CartItem[]
}


//
// -------------------------
//        CARTITEM
// -------------------------
//

model CartItem {
  id        Int      @id @default(autoincrement())
  cartId    Int
  cart      Cart     @relation(fields: [cartId], references: [id])
  productId Int
  product   Product  @relation(fields: [productId], references: [id])
  qty       Int
}

//
// -------------------------
//        PAYMENT
// -------------------------
//

model Payment {
  id          Int      @id @default(autoincrement())
  order       Order    @relation(fields: [orderId], references: [id])
  orderId     Int      @unique 

  method      String   // "EASYPaisa" | "JazzCash"
  amount      Float
  status      String   @default("PENDING") // PENDING, SUCCESS, FAILED
  transactionId String?  // easypaisa/jazzcash response txn id

  createdAt   DateTime @default(now())
}
//
// -------------------------
//        NOTIFICATION
// -------------------------
//
model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int?       // User ke liye
  sellerId  Int?       // Seller ke liye
  role      String?    // Admin ke liye: "ADMIN"
  message   String
  link      String?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  user    User?   @relation(fields: [userId], references: [id])
  seller  Seller? @relation(fields: [sellerId], references: [id])
}
model StoreSetting {
  id               Int      @id @default(1)
  logoUrl          String?
  bannerUrl        String?
  storeName        String?
  primaryColor     String   @default("#80B500")
  trendingLimit    Int      @default(10)
  featuredLimit    Int      @default(10)
  updatedAt        DateTime @updatedAt
}
